pool:
  vmImage: 'Ubuntu 16.04'
#Your build pipeline references a secret variable named ‘sp_username’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab, and then select the option to make it secret. See https://go.microsoft.com/fwlink/?linkid=865972
#Your build pipeline references a secret variable named ‘sp_password’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab, and then select the option to make it secret. See https://go.microsoft.com/fwlink/?linkid=865972

# Azure Pipeline Definition for Infrastructure Deployment
name: Deploy AML Infrastructure

# Trigger on changes in the infrastructure folder and on the master branch                      
trigger:
  branches:
    include:
    - master

  paths:
    include:
    - /*
    - infra-as-code/*
    - parameters/*
    - pipeline-as-code/*

parameters:
- name: baseName
  type: string
  default: povl
- name: environment
  type: string
  default: dev
  values: 
  - test
  - dev
- name: location
  type: string
  default: eastus
- name: serviceConnection
  type: string
  default: pavle-svc
- name: workspacename
  type: string
  default: mls
- name: computename
  type: string
  default: traincompute
- name: amlenv
  type: string
  default: traincompute
- name: applicationinsights
  type: string
  default: ain
- name: storageaccount
  type: string
  default: sa
- name: secretname
  type: string
  default: bentleysecret
- name: datastore
  type: string
  default: ds
- name: containername
  type: string
  default: pid
- name: containerregistry
  type: string
  default: cr
- name: keyvault
  type: string
  default: kv
- name: vmsize
  type: string
  default: STANDARD_D2_V2
- name: maxnodes
  type: number
  default: 5
- name: minnodes
  type: number
  default: 2

stages:
- stage: BuildInfra
  displayName: 'Build Azure Infrastructure'
  jobs:
  - template: infra-as-code/azure-infra.yml
    parameters:
      baseName: ${{ parameters.baseName }}
      environment: ${{ parameters.environment }}
      location: ${{ parameters.location }}
      workspacename: ${{ parameters.workspacename }}
      computename:  ${{ parameters.computename }}
      applicationinsights:  ${{ parameters.applicationinsights}}
      keyvault:  ${{ parameters.keyvault }}
      storageaccount: ${{ parameters.storageaccount }}
      secretname: ${{ parameters.secretname }}
      containername: ${{ parameters.containername }}
      containerregistry: ${{ parameters.containerregistry }}
      vmsize: ${{ parameters.vmsize }}
      maxnodes: ${{ parameters.maxnodes }}
      minnodes: ${{ parameters.minnodes }}
      serviceConnection:  ${{ parameters.serviceConnection }}

- stage: BuildPipes
  displayName: 'Build Pipeline Components'
  jobs:
  - template: pipeline-as-code/azure-ml-pipeline.yml
    parameters:
      baseName: ${{ parameters.baseName }}
      environment: ${{ parameters.environment }}
      location: ${{ parameters.location }}
      workspacename: ${{ parameters.workspacename }}
      computename:  ${{ parameters.computename }}
      serviceConnection:  ${{ parameters.serviceConnection }}
      amlenv: ${{ parameters.amlenv }}
      datastore: ${{ parameters.datastore }}



